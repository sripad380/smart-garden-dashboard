<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Smart Garden Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ---------- Global ---------- */
body {
  font-family: Arial, sans-serif;
  background: #eef2f3;
  padding: 20px;
  margin: 0;
}
h2, h3 {
  margin-top: 0;
}
.card {
  background: #ffffff;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 5px #0002;
}
.cards-row {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}
.card-half {
  flex: 1 1 320px;
}

/* ---------- Connect button ---------- */
#connectBtn {
  padding: 10px 16px;
  margin: 10px 0 20px;
  background: #4CAF50;
  border: none;
  color: white;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
}

/* ---------- iOS-style toggle ---------- */
.toggle-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 6px 0 12px;
}
.toggle-label-text {
  font-weight: bold;
  min-width: 140px;
}
.toggle {
  position: relative;
  width: 50px;
  height: 28px;
}
.toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  border-radius: 34px;
  transition: 0.3s;
}
.toggle-slider::before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background-color: #fff;
  border-radius: 50%;
  transition: 0.3s;
  box-shadow: 0 1px 3px #0004;
}
.toggle input:checked + .toggle-slider {
  background-color: #4CAF50;
}
.toggle input:checked + .toggle-slider::before {
  transform: translateX(22px);
}

/* ---------- Environment visuals ---------- */
.thermo {
  width: 60px;
  height: 200px;
  background: #ddd;
  border-radius: 30px;
  position: relative;
  margin: 10px auto;
  overflow: hidden;
}
.thermo-fill {
  position: absolute;
  bottom: 0;
  width: 100%;
  background: #ff4d4d;
  transition: height 0.3s;
}

.humidity-icon {
  width: 80px;
  height: 110px;
  margin: 20px auto;
  position: relative;
}
.humidity-drop {
  width: 80px;
  height: 110px;
  background: #b3e5fc;
  border-radius: 50% 50% 60% 60%;
  position: relative;
  overflow: hidden;
  box-shadow: 0 0 10px #90caf9 inset;
}
.humidity-fill {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 0%;
  background: #0288d1;
  transition: height 0.3s;
}

.soil-box {
  width: 120px;
  height: 120px;
  border: 3px solid #5d4037;
  border-radius: 10px;
  margin: 20px auto;
  position: relative;
  overflow: hidden;
  background: #f3e5ab;
}
.soil-water {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 0%;
  background: rgba(33, 150, 243, 0.6);
  transition: height 0.4s ease;
}

.sun-meter-box {
  width: 220px;
  height: 30px;
  background: #fff8e1;
  border-radius: 20px;
  margin: 20px auto;
  position: relative;
  overflow: hidden;
  border: 2px solid #ffca28;
}
.sun-meter-fill {
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 0%;
  background: linear-gradient(to right,
    #fff59d,
    #ffe082,
    #ffca28,
    #ffb300
  );
  transition: width 0.4s ease;
}

/* ---------- Speedometer ---------- */
.speedometer-container {
  width: 260px;
  height: 140px;
  margin: 15px auto 5px;
  position: relative;
}
.speedometer-arc {
  width: 100%;
  height: 100%;
  border-radius: 260px 260px 0 0;
  background: conic-gradient(
    from 180deg,
    #f44336,
    #ff9800,
    #ffeb3b
  );
  mask: radial-gradient(circle at 50% 100%, transparent 58%, black 59%);
}
.speedometer-inner {
  position: absolute;
  left: 15px;
  right: 15px;
  top: 15px;
  bottom: 0;
  border-radius: 260px 260px 0 0;
  background: #222;
  mask: radial-gradient(circle at 50% 100%, transparent 58%, black 59%);
}
.speedometer-ticks div {
  position: absolute;
  width: 2px;
  height: 12px;
  background: #eee;
  left: 50%;
  top: 18px;
  transform-origin: center 90px;
}
.speedometer-needle {
  position: absolute;
  left: 50%;
  bottom: 0;
  width: 4px;
  height: 80px;
  background: #ffeb3b;
  transform-origin: center bottom;
  transform: rotate(-90deg);
  transition: transform 0.15s linear;
}
.speedometer-knob {
  position: absolute;
  left: 50%;
  bottom: 0;
  width: 26px;
  height: 26px;
  border-radius: 50%;
  background: #f5f5f5;
  border: 3px solid #ffeb3b;
  transform: translateX(-50%) translateY(12px);
  cursor: grab;
}
.speedometer-value {
  text-align: center;
  margin-top: 4px;
  font-weight: bold;
}

/* ---------- Vertical LED slider ---------- */
.vertical-slider-box {
  width: 40px;
  height: 180px;
  background: #e0e0e0;
  border-radius: 20px;
  position: relative;
  overflow: hidden;
}
.vertical-slider-fill {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 0%;
  background: linear-gradient(to top, #ffcc80, #ff9800);
  transition: height 0.2s;
}
.vertical-slider-thumb {
  position: absolute;
  left: 50%;
  width: 34px;
  height: 10px;
  background: #ffffff;
  border-radius: 6px;
  transform: translateX(-50%) translateY(50%);
  cursor: grab;
}

/* ---------- Mobile Responsive ---------- */
@media (max-width: 768px) {
  body { padding: 10px; }
  .cards-row { flex-direction: column; }
  .speedometer-container { width: 200px; height: 110px; }
  .vertical-slider-box { height: 150px; }
}
</style>
</head>

<body>

<h2>ðŸŒ± Smart Garden BLE Dashboard</h2>
<button id="connectBtn">Connect to SmartGardenESP32</button>

<!-- ENVIRONMENT CARD -->
<div class="card">
  <h3>Environment</h3>
  <div style="display:flex; justify-content:space-around; flex-wrap:wrap;">

    <!-- Temperature -->
    <div style="text-align:center;">
      <h4>Temperature</h4>
      <div class="thermo"><div class="thermo-fill" id="thermoFill"></div></div>
      <p><b><span id="temp">--</span> Â°C</b></p>
    </div>

    <!-- Humidity -->
    <div style="text-align:center;">
      <h4>Humidity</h4>
      <div class="humidity-icon">
        <div class="humidity-drop">
          <div class="humidity-fill" id="humidityFill"></div>
        </div>
      </div>
      <p><b><span id="hum">--</span>%</b></p>
    </div>

    <!-- Soil -->
    <div style="text-align:center;">
      <h4>Soil Moisture</h4>
      <div class="soil-box">
        <div class="soil-water" id="soilWater"></div>
      </div>
      <p><b><span id="soilPercent">--</span>%</b></p>
    </div>

    <!-- Light -->
    <div style="text-align:center;">
      <h4>Light Level</h4>
      <div class="sun-meter-box">
        <div class="sun-meter-fill" id="lightMeter"></div>
      </div>
      <p><b><span id="lightPercent">--</span>%</b></p>
    </div>

  </div>
</div>

<div class="cards-row">

  <!-- PUMP CONTROL -->
  <div class="card card-half">
    <h3>Pump Control</h3>

    <div class="toggle-wrapper">
      <div class="toggle-label-text">Pump Power</div>
      <label class="toggle">
        <input type="checkbox" id="pumpToggle">
        <span class="toggle-slider"></span>
      </label>
    </div>

    <div class="speedometer-container" id="speedometer">
      <div class="speedometer-arc"></div>
      <div class="speedometer-inner"></div>
      <div class="speedometer-ticks" id="speedometerTicks"></div>
      <div class="speedometer-needle" id="speedometerNeedle"></div>
      <div class="speedometer-knob" id="speedometerKnob"></div>
    </div>

    <div class="speedometer-value">
      Pump Speed: <span id="pumpSpeedVal">0</span>
    </div>
  </div>

  <!-- LED CONTROL -->
  <div class="card card-half">
    <h3>LED Grow Light</h3>

    <div class="toggle-wrapper">
      <div class="toggle-label-text">LED Power</div>
      <label class="toggle">
        <input type="checkbox" id="ledToggle">
        <span class="toggle-slider"></span>
      </label>
    </div>

    <div class="vertical-slider-box" id="ledSliderBox">
      <div class="vertical-slider-fill" id="ledSliderFill"></div>
      <div class="vertical-slider-thumb" id="ledSliderThumb"></div>
    </div>

    <div style="text-align:center;">
      Brightness: <b><span id="ledVal">0</span></b>
    </div>
  </div>

</div>

<!-- MANUAL OVERRIDE -->
<div class="card">
  <h3>Manual Override</h3>
  <div class="toggle-wrapper">
    <div class="toggle-label-text">Override</div>
    <label class="toggle">
      <input type="checkbox" id="overdriveToggle">
      <span class="toggle-slider"></span>
    </label>
  </div>
</div>

<!-- THRESHOLDS -->
<div class="card">
  <h3>Automation Thresholds</h3>

  <div class="threshold-row">
    <span><b>Soil Dry Threshold:</b></span>
    <input type="number" id="soilThresh" />
    <button onclick="sendThreshold('SET_MOISTURE_THRESH')">Set</button>
  </div>

  <div class="threshold-row">
    <span><b>Light Low Threshold:</b></span>
    <input type="number" id="lightThresh" />
    <button onclick="sendThreshold('SET_LIGHT_THRESH')">Set</button>
  </div>

</div>

<script>
/* ---------- BLE UUIDs ---------- */
const SERVICE_UUID = "4e520001-3c8c-4824-8f7d-2b4421d8b63e";
const DATA_UUID    = "4e520002-3c8c-4824-8f7d-2b4421d8b63e";
const CMD_UUID     = "4e520003-3c8c-4824-8f7d-2b4421d8b63e";

let device, server, service;
let dataChar, cmdChar;

/* ---------- Connect ---------- */
document.getElementById("connectBtn").onclick = async () => {
  try {
    device = await navigator.bluetooth.requestDevice({
      filters: [{ name: "SmartGardenESP32" }],
      optionalServices: [SERVICE_UUID]
    });

    server = await device.gatt.connect();
    service = await server.getPrimaryService(SERVICE_UUID);
    dataChar = await service.getCharacteristic(DATA_UUID);
    cmdChar  = await service.getCharacteristic(CMD_UUID);

    await dataChar.startNotifications();
    dataChar.addEventListener("characteristicvaluechanged", handleNotify);

    alert("Connected!");
  } catch (e) {
    alert("Connection Failed: " + e);
  }
};

/* ---------- Notification handler ---------- */
function handleNotify(event) {
  const text = new TextDecoder().decode(event.target.value);
  try {
    const d = JSON.parse(text);

    /* Temperature */
    document.getElementById("temp").innerText = d.T.toFixed(1);
    document.getElementById("thermoFill").style.height = d.T + "%";

    /* Humidity */
    document.getElementById("hum").innerText = d.H.toFixed(1);
    document.getElementById("humidityFill").style.height = d.H + "%";

    /* Soil */
    let soilPercent = (d.M / 4095) * 100;
    document.getElementById("soilPercent").innerText = soilPercent.toFixed(0);
    document.getElementById("soilWater").style.height = soilPercent + "%";

    /* Light */
    let lightPercent = (d.L / 4095) * 100;
    document.getElementById("lightPercent").innerText = lightPercent.toFixed(0);
    document.getElementById("lightMeter").style.width = lightPercent + "%";

    /* Pump speed */
    setPumpSpeedUI(d.P);

    /* LED brightness */
    setLEDSliderUI(d.S);

  } catch (err) {
    console.log("Invalid JSON:", text);
  }
}

/* ---------- Utility ---------- */
function clamp(v, min, max) {
  return Math.min(max, Math.max(min, v));
}

async function sendCmd(cmd) {
  if (!cmdChar) return alert("Not connected!");
  await cmdChar.writeValue(new TextEncoder().encode(cmd));
}

/* ---------- Pump Speedometer ---------- */
const needle = document.getElementById("speedometerNeedle");
const knob = document.getElementById("speedometerKnob");
const speedDisplay = document.getElementById("pumpSpeedVal");
const pumpToggle = document.getElementById("pumpToggle");

let isDraggingNeedle = false;
let currentPumpSpeed = 0;

function speedToAngle(speed) {
  return -90 + (speed / 255) * 180;
}
function angleToSpeed(angle) {
  return Math.round(((angle + 90) / 180) * 255);
}

function setPumpSpeedUI(speed) {
  currentPumpSpeed = clamp(speed, 0, 255);
  needle.style.transform = `rotate(${speedToAngle(currentPumpSpeed)}deg)`;
  speedDisplay.textContent = currentPumpSpeed;
}

function sendPumpSpeed() {
  if (pumpToggle.checked) sendCmd("SET_PUMP_SPEED:" + currentPumpSpeed);
}

knob.addEventListener("pointerdown", e => {
  e.preventDefault();
  isDraggingNeedle = true;
});
window.addEventListener("pointermove", e => {
  if (!isDraggingNeedle) return;
  const rect = knob.parentElement.getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.bottom;
  const x = e.clientX - cx;
  const y = e.clientY - cy;
  let angle = Math.atan2(x, -y) * (180 / Math.PI);
  angle = clamp(angle, -90, 90);
  setPumpSpeedUI(angleToSpeed(angle));
});
window.addEventListener("pointerup", () => {
  if (isDraggingNeedle) {
    isDraggingNeedle = false;
    sendPumpSpeed();
  }
});

pumpToggle.addEventListener("change", () => {
  if (pumpToggle.checked) {
    sendCmd("PUMP_ON");
    sendPumpSpeed();
  } else {
    sendCmd("PUMP_OFF");
  }
});

/* ---------- LED Slider ---------- */
const ledSliderBox = document.getElementById("ledSliderBox");
const ledFill = document.getElementById("ledSliderFill");
const ledThumb = document.getElementById("ledSliderThumb");
const ledValLabel = document.getElementById("ledVal");
const ledToggle = document.getElementById("ledToggle");

let isDraggingLED = false;
let currentLEDVal = 0;

function setLEDSliderUI(value) {
  currentLEDVal = clamp(value,
